#!/usr/bin/env python3
# Automated DMA Attack Test Harness

import subprocess
import time
import json
from pathlib import Path

def run_command(cmd, cwd):
    print(f"[*] Running: {' '.join(cmd)} in {cwd}")
    result = subprocess.run(
        cmd,
        cwd=cwd,
        capture_output=True,
        text=True,
        check=False
    )
    if result.returncode != 0:
        print(f"[!] Command failed with code {result.returncode}")
        print(f"    STDOUT: {result.stdout}")
        print(f"    STDERR: {result.stderr}")
    return result.returncode == 0

def run_scanner():
    print("[*] Running hardware scanner...")
    return run_command(["sudo", "./hardware_scanner"], "scanners")

def run_exploit():
    print("[*] Running DMA exploit...")
    return run_command(["sudo", "./dma_exploit"], "exploits")

def test_ta_loading():
    print("[*] Testing TA loading...")
    # Would invoke OP-TEE to load test TA
    print("[!] Manual test required: Try loading test_ta")
    return True

def main():
    print("=== DMA Attack Test Harness ===\n")
    
    if not run_command(["./compile_scanner.sh"], "scanners"):
        print("[!] Scanner compilation failed")
        return

    if not run_scanner():
        print("[!] Scanner failed")
        return
    
    time.sleep(2)
    
    if not run_command(["./compile_exploit.sh"], "exploits"):
        print("[!] Exploit compilation failed")
        return

    if not run_exploit():
        print("[!] Exploit failed")
        return
    
    time.sleep(2)
    
    test_ta_loading()
    
    print("\n[+] Test harness complete!")

if __name__ == "__main__":
    main()
